{% extends "base.html" %}

{% block title %}Airbyte - DataHub{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Gestione Connessioni Airbyte</h2>
            <p class="mt-1 text-sm text-gray-500">Monitora e gestisci le connessioni Airbyte</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="loadConnections()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <i class="fas fa-sync-alt mr-2"></i>
                Aggiorna
            </button>
            <a href="http://localhost:8000" target="_blank" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700">
                <i class="fas fa-external-link-alt mr-2"></i>
                Apri Airbyte Console
            </a>
        </div>
    </div>

    <!-- Airbyte Status -->
    <div id="airbyte-status" class="bg-white shadow rounded-lg mb-6 p-6">
        <div class="flex items-center">
            <div id="status-icon" class="flex-shrink-0">
                <i class="fas fa-circle text-2xl text-gray-400"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-medium text-gray-900" id="status-text">Verifica connessione...</h3>
                <p class="text-sm text-gray-500" id="status-details">-</p>
            </div>
        </div>
    </div>

    <!-- Connections Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Connessioni</h3>
            
            <div id="connections-table" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Destination</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ultima Sync</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="connections-tbody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin mr-2"></i> Caricamento...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    async function checkAirbyteStatus() {
        try {
            const response = await fetch('/api/airbyte/status');
            if (!response.ok) throw new Error('Error checking status');
            
            const data = await response.json();
            updateStatusUI(data.connected);
        } catch (error) {
            updateStatusUI(false);
        }
    }

    function updateStatusUI(connected) {
        const statusCard = document.getElementById('airbyte-status');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');

        if (connected) {
            statusCard.className = 'bg-green-50 border border-green-200 shadow rounded-lg mb-6 p-6';
            statusIcon.innerHTML = '<i class="fas fa-check-circle text-2xl text-green-500"></i>';
            statusText.textContent = 'Airbyte è raggiungibile';
            statusText.className = 'text-lg font-medium text-green-900';
            statusDetails.textContent = 'API Airbyte risponde correttamente';
        } else {
            statusCard.className = 'bg-red-50 border border-red-200 shadow rounded-lg mb-6 p-6';
            statusIcon.innerHTML = '<i class="fas fa-times-circle text-2xl text-red-500"></i>';
            statusText.textContent = 'Airbyte non è raggiungibile';
            statusText.className = 'text-lg font-medium text-red-900';
            statusDetails.textContent = 'Verifica che Airbyte sia avviato e accessibile';
        }
    }

    async function loadConnections() {
        try {
            const response = await fetch('/api/airbyte/connections');
            if (!response.ok) throw new Error('Error loading connections');
            
            const data = await response.json();
            updateConnectionsTable(data.connections || []);
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('connections-tbody').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-circle mr-2"></i> Errore nel caricamento
                    </td>
                </tr>
            `;
        }
    }

    function getStatusClass(status) {
        if (status === 'succeeded') return 'bg-green-100 text-green-800';
        if (status === 'failed') return 'bg-red-100 text-red-800';
        return 'bg-gray-100 text-gray-800';
    }

    function updateConnectionsTable(connections) {
        const tbody = document.getElementById('connections-tbody');
        
        if (connections.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        Nessuna connessione trovata
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = connections.map(conn => {
            const lastSync = conn.last_sync ? new Date(conn.last_sync).toLocaleString('it-IT') : 'Mai';
            const status = conn.last_sync_status || 'unknown';
            
            return `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${conn.name || 'Unnamed'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${conn.source?.name || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${conn.destination?.name || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${lastSync}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(status)}">
                            ${status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if user.has_permission('manage_airbyte') %}
                        <button onclick="triggerSync('${conn.connection_id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-play"></i> Sync
                        </button>
                        {% endif %}
                        <button onclick="viewConnection('${conn.connection_id}')" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-eye"></i> Dettagli
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function triggerSync(connectionId) {
        showConfirm(
            'Vuoi avviare una sync manuale per questa connessione?',
            'Conferma Sync',
            async (confirmed) => {
                if (!confirmed) return;

                try {
                    const response = await fetch(`/api/airbyte/connections/${connectionId}/sync`, {
                        method: 'POST'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert('Sync avviata con successo!', 'Successo', 'check-circle', 'green');
                        setTimeout(loadConnections, 2000); // Reload after 2 seconds
                    } else {
                        showAlert('Errore: ' + (data.error || 'Errore sconosciuto'), 'Errore', 'exclamation-circle', 'red');
                    }
                } catch (error) {
                    showAlert('Errore: ' + error.message, 'Errore', 'exclamation-circle', 'red');
                }
            }
        );
    }

    function viewConnection(connectionId) {
        // TODO: Implementare vista dettagli connessione
        showAlert('Vista dettagli per connessione ' + connectionId + ' (da implementare)', 'Info', 'info-circle', 'blue');
    }

    // Polling intelligente: evita polling se Airbyte è down
    let airbytePollingInterval = null;
    let airbyteIsDown = false;
    
    function startPolling() {
        if (airbytePollingInterval) return; // Già attivo
        
        airbytePollingInterval = setInterval(() => {
            if (!airbyteIsDown) {
                checkAirbyteStatus();
                loadConnections();
            }
        }, 60000); // Poll ogni minuto solo se Airbyte è up
    }
    
    function stopPolling() {
        if (airbytePollingInterval) {
            clearInterval(airbytePollingInterval);
            airbytePollingInterval = null;
        }
    }
    
    function updateStatusUI(connected) {
        const statusCard = document.getElementById('airbyte-status');
        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const statusDetails = document.getElementById('status-details');

        if (connected) {
            airbyteIsDown = false;
            statusCard.className = 'bg-green-50 border border-green-200 shadow rounded-lg mb-6 p-6';
            statusIcon.innerHTML = '<i class="fas fa-check-circle text-2xl text-green-500"></i>';
            statusText.textContent = 'Airbyte è raggiungibile';
            statusText.className = 'text-lg font-medium text-green-900';
            statusDetails.textContent = 'API Airbyte risponde correttamente';
            startPolling(); // Avvia polling solo se Airbyte è up
        } else {
            airbyteIsDown = true;
            statusCard.className = 'bg-red-50 border border-red-200 shadow rounded-lg mb-6 p-6';
            statusIcon.innerHTML = '<i class="fas fa-times-circle text-2xl text-red-500"></i>';
            statusText.textContent = 'Airbyte non è raggiungibile';
            statusText.className = 'text-lg font-medium text-red-900';
            statusDetails.textContent = 'Verifica che Airbyte sia avviato e accessibile. Polling disabilitato per ridurre carico CPU.';
            stopPolling(); // Ferma polling se Airbyte è down
            // Prova a riconnettere ogni 5 minuti
            setTimeout(() => {
                if (airbyteIsDown) {
                    checkAirbyteStatus();
                }
            }, 300000); // 5 minuti
        }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', () => {
        checkAirbyteStatus();
        loadConnections();
        // Non avviare polling automatico - sarà avviato solo se Airbyte è up
    });
</script>
{% endblock %}
